<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Heart â€“ Show/Hide Labels (Sheet-driven)</title>

  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      margin: 1.5rem;
      background: #ffffff;
    }

    .diagram-wrap {
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: .75rem;
      background: #fafafa;
      max-width: 900px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.25rem;
      margin-top: 0;
    }

    #label-instructions {
      font-size: 0.95rem;
      color: #374151;
      margin-bottom: 0.75rem;
    }

    .toggles {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .toggles button {
      padding: 0.4rem 0.6rem;
      border-radius: 0.4rem;
      border: 1px solid #bbb;
      background: #ffffff;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .toggles button[aria-pressed="true"] {
      background: #e8e8e8;
      font-weight: 600;
    }

    .toggles button:focus-visible {
      outline: 2px solid #2563eb;
      outline-offset: 2px;
    }

    svg {
      width: 100%;
      height: auto;
      display: block;
    }

    .is-hidden {
      display: none;
    }

    .label-bg {
      fill: white;
      stroke: #000;
      stroke-width: 1;
    }

    .label {
      font-family: system-ui, sans-serif;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <main class="diagram-wrap">
    <h1>Heart â€“ Show/Hide Labels</h1>

    <p id="label-instructions">
      Use the buttons below to show or hide labels on the diagram. Each button controls
      a label with the same name inside the heart illustration.
    </p>

    <!-- Buttons will be auto-generated here -->
    <div class="toggles"
         role="toolbar"
         aria-label="Heart label toggles"
         aria-describedby="label-instructions"></div>

    <!-- ðŸ”» REPLACE THIS SVG WITH YOUR OWN EXPORT (keep id="Label_*" on label groups) -->
    <!-- START SVG -->
    <svg
      viewBox="0 0 800 500"
      xmlns="http://www.w3.org/2000/svg"
      role="img"
      aria-labelledby="heart-title heart-desc"
    >
      <title id="heart-title">Human heart anatomy diagram</title>
      <desc id="heart-desc">
        A simplified diagram of the human heart with labeled structures.
      </desc>

      <!-- Temporary simple demo labels; swap in your full Illustrator SVG here -->
      <g id="Label_Right_ventricle">
        <text class="label" x="200" y="160">Right ventricle</text>
      </g>
      <g id="Label_Posterior_interventricular_artery">
        <text class="label" x="200" y="190">Posterior interventricular artery</text>
      </g>
      <g id="Label_Inferior_vena_cava">
        <text class="label" x="200" y="220">Inferior vena cava</text>
      </g>
      <g id="Label_Right_atrium">
        <text class="label" x="200" y="250">Right atrium</text>
      </g>
    </svg>
    <!-- END SVG -->

  </main>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const svg = document.querySelector('svg');
      const toolbar = document.querySelector('.toggles');
      if (!svg || !toolbar) {
        if (toolbar) toolbar.textContent = 'No SVG found on this page.';
        return;
      }

      // --- CONFIG: your Apps Script URL + language ---
      const SHEET_API_URL = 'https://script.google.com/a/macros/macmillan.com/s/AKfycbx9Q497bGL6gSw4LWa2EoQ4GtDNfEnCwVsJvyxQggI2VAFQPU0FBR4LOFpfF4pm2mEE/exec'; // <-- paste your URL
      const LANG = 'en'; // change to 'es' later if needed

      // 1) Collect label groups from SVG
      const labelEls = Array.from(svg.querySelectorAll('[id^="Label_"]'));
      if (!labelEls.length) {
        toolbar.textContent = 'No Label_* groups found in this SVG.';
        return;
      }

      // 2) Fetch label data from Google Sheets
      let labelData = [];
      try {
        const res = await fetch(
          SHEET_API_URL + '?lang=' + encodeURIComponent(LANG),
          { cache: 'no-store' }
        );
        if (!res.ok) throw new Error('HTTP ' + res.status);
        labelData = await res.json();
      } catch (err) {
        console.error('Failed to load label data from Sheet:', err);
        // Fallback: proceed with SVG labels as-is
        labelData = [];
      }

      // Index data by id for quick lookup
      const dataById = {};
      labelData.forEach(item => {
        if (item.id) dataById[item.id] = item;
      });

      // 3) Apply text / tooltip / initial visibility from Sheet
      labelEls.forEach(el => {
        const info = dataById[el.id];
        if (!info) return; // if no row, leave SVG as-is

        // set text content (assumes a <text> element inside the group)
        const textNode = el.querySelector('text');
        if (textNode && info.text) {
          textNode.textContent = info.text;
        }

        // set a title/tooltip on the group if provided
        if (info.tooltip) {
          el.setAttribute('aria-label', info.tooltip);
          el.setAttribute('title', info.tooltip);
        }

        // set initial visibility
        if (info.visible === false) {
          el.classList.add('is-hidden');
        } else {
          el.classList.remove('is-hidden');
        }
      });

      // 4) Randomize label order for buttons (Fisherâ€“Yates)
      const shuffledLabels = [...labelEls];
      for (let i = shuffledLabels.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffledLabels[i], shuffledLabels[j]] = [shuffledLabels[j], shuffledLabels[i]];
      }

      const buttons = [];

      // 5) Build buttons in randomized order
      shuffledLabels.forEach(el => {
        const id = el.id;
        const info = dataById[id];
        const fallbackName = id.replace(/^Label_/, '').replace(/_/g, ' ');
        const name = info && info.text ? info.text : fallbackName;

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.dataset.target = id;
        btn.setAttribute('aria-controls', id);

        // pressed state = visible state
        const isHidden = el.classList.contains('is-hidden');
        btn.setAttribute('aria-pressed', isHidden ? 'false' : 'true');
        btn.textContent = name;

        toolbar.appendChild(btn);
        buttons.push(btn);
      });

      // 6) Add "Toggle All"
      const allButton = document.createElement('button');
      allButton.type = 'button';
      allButton.id = 'toggle-all';
      allButton.textContent = 'Toggle All';
      allButton.setAttribute('aria-pressed', 'false');
      toolbar.appendChild(allButton);

      function toggle(id) {
        const el = svg.querySelector('#' + CSS.escape(id));
        if (!el) return;
        const hidden = el.classList.toggle('is-hidden');
        const btn = buttons.find(b => b.dataset.target === id);
        if (btn) btn.setAttribute('aria-pressed', hidden ? 'false' : 'true');
      }

      // 7) Individual button behavior
      buttons.forEach(btn => {
        btn.addEventListener('click', () => toggle(btn.dataset.target));
      });

      // 8) Toggle All behavior
      allButton.addEventListener('click', () => {
        const anyVisible = labelEls.some(el => !el.classList.contains('is-hidden'));
        labelEls.forEach(el => el.classList.toggle('is-hidden', anyVisible));
        buttons.forEach(b => b.setAttribute('aria-pressed', anyVisible ? 'false' : 'true'));
        allButton.setAttribute('aria-pressed', anyVisible ? 'false' : 'true');
      });
    });
  </script>
</body>
</html>
